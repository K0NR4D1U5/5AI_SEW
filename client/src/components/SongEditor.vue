<template>
    <div class="song-editor">
        <md-toolbar class="md-dense">
            <div class="md-toolbar-section-start">
                <md-button class="md-icon-button" :to="{ name: 'song-view' }">
                    <md-icon>arrow_back</md-icon>
                </md-button>
                <div class="md-title">Song bearbeiten</div>
            </div>

            <div class="md-toolbar-section-end">
                <md-button class="md-icon-button"
                     @click="save"
                     :disabled="$v.$invalid">
                    <md-icon>check</md-icon>
                </md-button>
            </div>
        </md-toolbar>

        <md-vuelidated
            field="md-field"
            class="md-layout-item">
            <label>Titel</label>
            <md-input type="text" v-model="song.title" />

            <md-vuelidated-msg constraint="required">
                Dies ist ein Pflichtfeld.
            </md-vuelidated-msg>
            <md-vuelidated-msg constraint="minLength" v-slot="{ min }">
              Der Titel muss mindestens {{ min }} Zeichen lang sein.
            </md-vuelidated-msg>
        </md-vuelidated>

        <md-vuelidated
            field="md-field"
            class="md-layout-item">
          <label>Interpret</label>
          <md-input type="text" v-model="song.artist" />

          <md-vuelidated-msg constraint="required">
            Dies ist ein Pflichtfeld.
          </md-vuelidated-msg>
        </md-vuelidated>

        <md-vuelidated
            field="md-field"
            class="md-layout-item">
          <label>Genre</label>
          <md-input type="text" v-model="song.genre" />

          <md-vuelidated-msg constraint="required">
            Dies ist ein Pflichtfeld.
          </md-vuelidated-msg>
        </md-vuelidated>

        <md-field>
            <label>Audiodatei</label>
            <md-file @md-change="readAudioFile" accept="audio/*" />
        </md-field>

        <div v-if="errors">
        <span v-for="error in errors">
          {{ error.message }}
        </span>
        </div>
    </div>
</template>

<script>
import Song from '@/models/Song'
import { saveEntity } from '@/services/rest'
import { required, minLength, between } from 'vuelidate/lib/validators'

export default {
    name: 'SongEditor',

    props: {
        song: {
            type: Song,
            default: () => new Song(),
        },
    },

    data: () => ({
      errors: []
    }),

    methods: {
        save() {
            saveEntity(this.song)
                .then(savedSong => {
                    this.$router.back()
                })
                .catch(errors => {
                  console.log("in editor: ",errors)
                  this.errors = errors
                })
        },

        readAudioFile(fileList) {
            const reader = new FileReader()
            reader.onload = event => {
                this.song.audio = event.target.result
            }
            reader.readAsDataURL(fileList[0])
        },
    },

    validations: {
        song: {
            title: {
              required,
              minLength: minLength(2)
            },
            artist: {
              required,
            },
            genre: {
              required,
            },
            audio: {},
        }
    }
}
</script>

<style>
.song-editor .md-toolbar {
    position: fixed;
    top: 0;
    left: 0;
}
</style>